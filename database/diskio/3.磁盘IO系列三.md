在第一部分和第二部分中，我们讨论了有助于在磁盘上执行写入的底层操作系统机制。现在，是时候开始转向更高层次的概念了。

今天，我们将探讨数据库中经常使用的一种存储类型。它们每个都有自己的优点和缺点，因此构建数据库系统总是需要权衡取舍，我们也会尝试解决其中的一些问题。

#### 可变数据结构与不可变数据结构
我们将在下一章讨论的数据结构之间的差异可变性（不可变性）。在这里，我们将讨论磁盘上的可变性，因此构造语义和函数式编程相关概念与我们讨论的目的无关。

不可变数据结构的明显优势是可以最小化存储开销：我们不必为后面插入的数据或更新记录留任何额外空间。

保持数据结构不可变有利于顺序写入：数据仅追加写入磁盘，。可变数据结构将在首次写入预先分配，但后续写入将是随机的。有些结构需要节点拆分，这将重新定位已写入的部分。一段时间后，随机写入的文件可能需要进行碎片整理。

一些数据库不进行就地更新，只是将过时的记录标记为“已删除”（这样它最终将被垃圾收集），并将新记录附加到文件的特别指定的更新区域。虽然这是一个不错的折衷方案，但有时写入会填满所有指定空间，并且必须创建溢出区域。所有这些都可能减慢后续的读取和写入。

不可变文件的另一个优点是，可以从磁盘读取数据，而无需在操作之间进行任何段锁定，这大大简化了并发访问。
相反，可变数据结构采用分层锁和闩锁，以确保磁盘上数据结构的完整性，允许多个读取器同时访问，但将树部分的独占所有权授予写入器。

可变和不可变数据结构都需要一些内部处理以优化性能，但出于不同的原因。由于分配的文件数量不断增长，不可变数据结构必须合并和重写文件，以确保在查询期间命中的文件数量最少，因为请求的记录可能分布在多个文件中。另一方面，可变文件可能必须部分或完全重写以减少碎片，合并溢出区域并回收更新或删除记录占用的空间（因为它们的新内容已写入其他地方）。当然内部处理过程的确切工作范围在很大程度上取决于具体的实施。

在查看 LSM-Tree（日志结构化合并树）和 B-Tree 变体时，我们将讨论可变和不可变存储的案例。