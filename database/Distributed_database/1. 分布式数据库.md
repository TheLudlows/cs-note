[toc]

#### 1. 分布式数据库

“分布式数据库”在字面上可以分解为“分布式”和“数据库”两部分，代表了它是跨学科的产物，它的理论基础来自两个领域。这同时也呼应了产品发展的两条不同路径，一些产品是从分布式存储系统出发，进而增加关系型数据库的能力；另外一些产品是从单体数据库出发，增加分布式技术元素。
#### 2. 类似的产物

1. 客户端组件+单体数据库

   通过独立的逻辑层建立数据分片和路由规则，实现单体数据库的初步管理，使应用能够对接多个单体数据库，实现并发、存储能力的扩展。其作为应用系统的一部分，对业务侵入较为深。这种客户端组件的典型产品是Sharding-JDBC。

2. 代理中间件+单体数据库

   以独立中间件的方式，管理数据规则和路由规则，以独立进程存在，与业务应用层和单体数据库相隔离，减少了对应用的影响。随着代理中间件的发展，还会衍生出部分分布式事务处理能力。这种中间件的典型产品是MyCat。

3. 单元化架构+单体数据库

   单元化架构是对业务应用系统的彻底重构，应用系统被拆分成若干实例，配置独立的单体数据库，让每个实例管理一定范围的数据。例如对于银行贷款系统，可以为每个支行搭建独立的应用实例，管理支行各自的用户，当出现跨支行业务时，由应用层代码通过分布式事务组件保证事务的ACID特性。

   根据不同的分布式事务模型，应用系统要配合改造，复杂性也相应增加。例如TCC模型下，应用必须能够提供幂等操作。

看过这三种方案，它们共同的特点是单体数据库仍然能够被应用系统感知到。相反，分布式数据库则是将技术细节收敛到产品内部，以一个整体面对业务应用。



#### 3. 两种分布式数据库架构

##### 3.1 单机数据库

将数据库从逻辑上拆分为 5 个部分，分别是客户端 通讯管理器 (Client Communications Manager)、查询处理器（Relational Query Processor）、事务存储管理器（Transactional Storage Manager）、进程管理器 （Process Manager）和共享组件与工具 (Shared Components and Utilities)，每个部 分下面又可以拆分成一些组件。

![](./singledb.jpeg)

1. 客户端通讯管理器。这是应用开发者能够直观感受到的模块，通常我们使用 JDBC 或者 ODBC 协议访问数据库时，连接的就是这个部分。 
2.  进程管理器。连接建好了，数据库会为客户端分配一个进程，客户端后续发送的所有操 作都会通过对应的进程来执行。当然，这里的进程只是大致的说法。事实上，Oracle 和 PostgreSQL 是进程的方式，而 MySQL 使用的则是线程。
3. 查询处理器。它包括四个部分，功能上是顺序执行的。首先是解析器，它将接收到的 SQL 解析为内部的语法树。然后是查询重写（Query Rewrite），它也被称为逻辑优 化，主要是依据关系代数的等价变换，达到简化和标准化的目的，比如会消除重复条件 或去掉一些无意义谓词 ，还有将视图替换为表等操作。再往后就是查询算法优化 （Query Optimizer），它也被称为物理优化，主要是根据表连接方式、连接顺序和排 序等技术进行优化，我们常说的基于规则优化（RBO）和基于代价优化（CBO）就在这 部分。最后就是计划执行器（Plan Executor），最终执行查询计划，访问存储系统。
4. 事务存储管理器。它包括四个部分，其中访问方式（Access Methods）是指数据在磁 盘的具体存储形式。锁管理（Lock Manager）是指并发控制。日志管理（Log Manager）是确保数据的持久性。缓存管理（Buffer Manager）则是指 I/O 操作相关的缓存控制。
5. 共享组件和工具。在整个过程中还会涉及到的一些辅助操作，当然它们对于数据库的运 行也是非常重要的。例如编目数据管理器（Catalog Manager）会记录数据库的表、字 段、视图等元数据信息，并根据这些信息来操作具体数据内容。复制机制 （Replication）也很重要，它是实现系统高可靠性的基础，在单体数据库中，通过主备 节点复制的方式来实现数据的复制。

##### 3.2 PG派系

但在面临高并发场景的时候单机数据库会碰到写入性能不足的问题，大家首先想到的，最直接的办法就是分库分表。

分库分表方案就是在多个单体数据库之前增加代理节点，本质上是增加了 SQL 路由功能。 这样，代理节点首先解析客户端请求，再根据数据的分布情况，将请求转发到对应的单体数据库。

<img src="./proxy.jpeg" style="zoom:50%;" />

代理节点需要实现三个主要功能，它们分别是客户端接入、简单的查询处理器和进程管理 中的访问控制。 另外，分库分表方案还有一个重要的功能，那就是分片信息管理，分片信息就是数据分布情况，是区别于编目数据的一种元数据。不过考虑到分片信息也存在多副本的一致性的问题，大多数情况下它会独立出来

如果把每一次的事务写入都限制在一个单体数据库内，业务场景就会很受局限。因 此，跨库事务成为必不可少的功能，但是单体数据库是不感知这个事情的，所以我们就要 在代理节点增加分布式事务组件。简单的分库分表不能满足全局性的查询需求，因为每个数据节点只能看到一部分数 据，有些查询运算是无法处理的，比如排序、多表关联等。所以，代理节点要增强查询计 算能力，支持跨多个单体数据库的查询。

很多分库分表方案会演进到这个阶段，比如 MyCat。这时离分布式数据库还差重要的一 步，就是全局时钟。加上这最后一块拼图，PG区别于单体数据库的功能也就介绍完整了，它们是分片、分布式事务、跨节点查询和全局时钟。

<img src="./pg.jpeg" style="zoom:50%;" />

协调节点与数据节点，实现了一定程度上的计算与存储分离，这也是所有分布式数据库的一个架构基调。但是，因为 PGXC 的数据节点本身就是完整的单体数据库，所以也具备很强的计算能力。

很多厂商在 PGXC 上二次开发，推出自己的产品。 不过，这些改动都没有变更主体架构风格，所以我把这类产品统称为 PGXC 风格，其中包 括 TBase、GuassDB 300 和 AntDB 等。

##### 3.3 NewSQL：革命性的新架构

NewSQL 也叫原生分布式数据库，就是说它的每个组件在设计之初都是 基于分布式架构的，不像 PGXC 那样带有明显的单体架构痕迹。

NewSQL 的基础是 NoSQL，更具体地说，是类似 BigTable 的分布式键值（K/V）系统。NoSQL将重点放在对 存储和写入能力的扩展上，这个能力扩展的基础就是分片。引入分片的另一个好处是，系统能够以更小的粒度调度数据，实现各节点上的存储平衡和访问负载平衡。

NewSQL 还有两个重要的革新，分别出现在高可靠机制和存储引擎的设计上。高可靠机制的变化在于，放弃了粒度更大的主从复制，转而以分片为单位采用 Paxos 或 Raft 等共识算法。这样，NewSQL 就实现了更小粒度的高可靠单元，获得了更高的系统整体可靠性。存储引擎层面，则是使用 LSM-Tree 模型替换 B+ Tree 模型，大幅提升了写入性能。

<img src="./newsql.jpeg" style="zoom:50%;" />

NewSQL主要的工作负载由计算节点和存储节点承担， 另外由管理节点承担全局时钟和分片信息管理功能。不过，这三类节点是逻辑功能上划分，在设计实现层面是可分可合的。

Spanner 是 NewSQL 的开山鼻祖，这个不用说了；其他知名度比较高的产品有 CockroachDB、TiDB 和 YugabyteDB，这三款数据库都宣称设计灵感来自 Spanner；另外就是阿里自研的 OceanBase。
